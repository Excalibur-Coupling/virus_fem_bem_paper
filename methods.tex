\subsection*{\sffamily \large The implicit solvent model}

The implicit solvent model can be described mathematically as a coupled system of partial differential equations, where the Poisson-Boltzmann governs in the solvent region ($\Omega_1$ in Figure XX), and the Poisson equation in the solute region ($\Omega_2$ in Figure XX). These regions are interfaced by the molecular surface ($\Gamma$), where the potential ($\phi$) and electric displacement ($\epsilon\partial\phi/\partial\mathbf{n}$) are continuous. 
%
\begin{align}\label{eq:pbe}
\nabla^2\phi_1(\mathbf{x}) &= \frac{1}{\epsilon_1}\sum_{k=1}^{N_q} q_k\delta(\mathbf{x},\mathbf{x}_k) \quad  \mathbf{x} \in \Omega_1\nonumber\\
\left(\nabla^2 - \kappa^2\right)\phi_2(\mathbf{x})  &= 0 \quad\mathbf{x}\in\Omega_2\nonumber\\
\phi_1(\mathbf{x})  = \phi_2 (\mathbf{x}), &\quad \epsilon_1\frac{\partial\phi_1}{\partial\mathbf{n}}(\mathbf{x})  = \epsilon_2\frac{\partial\phi_2}{\partial\mathbf{n}}(\mathbf{x})  \quad \mathbf{x}\in \Gamma. 
\end{align}
%
Here, $\epsilon_1$ and $\epsilon_2$ are the dielectric constants in the solute and solvent, respectively, $\kappa$ is the inverse of the Debye length, related with the salt concentration, and $q_k$ are the values of the partial charges, located at $\mathbf{x}_k$.

The electrostatic potential in $\Omega_1$ can be further decomposed into singular and regular components as $\phi_1 = \phi_c + \phi_r$, where $\phi_c$ is the solution to
%
\begin{align}\label{eq:phic}
\nabla^2\phi_c(\mathbf{x}) &= \frac{1}{\epsilon}\sum_{k=1}^{N_q}q_k\delta(\mathbf{x},\mathbf{x}_k) \quad \mathbf{x}\in\Omega_1\cup\Omega_2\nonumber\\
\phi_c(\mathbf{x})&=0 \quad \text{ as } |\mathbf{x}|\to\infty
\end{align}

Physically, $\phi_c$ can be interpreted as the Coulomb-type potential from the point charges, whereas $\phi_r$, also known as reaction potential, is originated by the polarization of the solvent and reorganization of the free ions. 
Usually, $\epsilon_1$ is considered a constant value, yielding an analytical expression for $\phi_c$, however, this is not the general case.

There are regularized versions of Equation \eqref{eq:pbe} \cite{LuZhouHolstMcCammon2008,LeeGengZhao2021} which are widely used to numerically solve the Poisson-Boltzmann equation with finite element or finite difference methods.
However, here we use the standard formulation in Equation \eqref{eq:pbe}, as it offers more flexibility when dealing with, for example, variable permitivitties.

A common quantity of interest in implicit solvent models is the solvation free energy, which the change in Gibbs free energy as the molecule moves from vacuum into the solvent. Considering the charge distribution $\rho$ consists of point charges, this can be calculated as
%
\begin{equation}\label{eq:dG} 
\Delta G_{solv} = \frac{1}{2}\int_{\Omega_1} \rho(\mathbf{x})\phi_{r}(\mathbf{x}) = \frac{1}{2}\sum_{k=1}^{N_q} q_k\phi_r(\mathbf{x_k})
\end{equation}

\subsection*{\sffamily \large Numerical solution of the Poisson-Boltzmann equation}

\subsection*{\sffamily \large BEM-BEM coupling}

The boundary element method (BEM) is a standard tool for the numerical solution of the Poisson-Boltzmann equation in molecular electrostatics.~\cite{ZauharMorgan1985, Shaw1985} This was implemented in numerous codes, such as AFMPB,~\cite{LuETal2006} TABI,~\cite{GengKrasny2013} PyGBe,~\cite{CooperBardhanBarba2014,cooper2016pygbe} and more recently, with Bempp-cl.~\cite{search2022towards} 

There are several possible boundary integral formulations of Equation \eqref{eq:pbe}.~\cite{search2022towards} The simplest form was presented by Yoon Âºand Lenhoff in 1991,~\cite{YoonLenhoff1990} known as the \emph{direct} formulation, however, the resulting system is usually ill-conditioned. Here, we use the better conditioned formulation presented by Lu and co-workers.~\cite{LuETal2006,LuETal2009,debuhr2016dashmm}
Applying Green's second identity to Equation \eqref{eq:pbe} we get 
%
\begin{align} \label{eq:volume_potential}
\phi_{1}(\mathbf{r}_{\Omega_1})+ K_{L}^{\Omega_1}(\phi_{1,\Gamma}) -  V_{L}^{\Omega_1} \lambda_1 & = \frac{1}{\epsilon_1} \sum_{k=0}^{N_q}  \frac{q_k}{4\pi|\mathbf{r}_{\Omega_1} - \mathbf{r}_k|}  \quad \text{on $\Omega_1$,} \nonumber \\
\phi_{2}(\mathbf{r}_{\Omega_2}) - K_{Y}^{\Omega_2}(\phi_{2,\Gamma}) + V_{Y}^{\Omega_2} \lambda_2& = 0 \quad \text{on $\Omega_2$,}
\end{align}
%
where $\mathbf{r}_\Omega$ is evaluated anywhere in the correspoding domain, except $\Gamma$, and $\phi_{1,\Gamma} = \phi_1(\mathbf{r}_\Gamma)$ and $\phi_{2,\Gamma} = \phi_2(\mathbf{r}_\Gamma)$ are the potentials on $\Gamma$ as we approach from $\Omega_1$ and $\Omega_2$, respectively. For convenience, we call the normal derivative on the interface ({\it ie.} the Neumann trace) $\lambda=\left(\frac{\partial}{\partial \mathbf{n}}  \phi_{\Gamma}  \right)$. $K$ and $V$ are the double- and single-layer potentials for the Laplace (subscript $L$) and Yukawa (subscript $Y$, also known as modified Helmholtz) kernels
%
\begin{align}\label{eq:single_double}
V^\Omega_{L,Y}(\varphi) = \oint_\Gamma g_{L,Y}(\mathbf{r}_\Omega,\mathbf{r}')\varphi(\mathbf{r}')d\mathbf{r}'\nonumber\\
K^\Omega_{L,Y}(\varphi) = \oint_\Gamma \frac{\partial g_{L,Y}}{\partial\mathbf{n}'}(\mathbf{r}_\Omega,\mathbf{r}')\varphi(\mathbf{r}')d\mathbf{r}',\nonumber\\
\end{align}
%
where $\varphi(\mathbf{r})$ can be any distribution over $\Gamma$, and 
%
\begin{align}\label{eq:green_func}
g_L(\mathbf{r},\mathbf{r}')=\frac{1}{4\pi|\mathbf{r}-\mathbf{r}'|} \nonumber \\
g_Y(\mathbf{r},\mathbf{r}')=\frac{e^{-\kappa|\mathbf{r}-\mathbf{r}'|}}{4\pi|\mathbf{r}-\mathbf{r}'|}
\end{align}
%
are the free-space Green's function of the Laplace and linearized Poisson-Boltzmann equations, respectively. 

If we take the limit of Eq. \eqref{eq:volume_potential} as $\mathbf{r}_{\Omega}$ approaches $\Gamma$, we get
%
\begin{align} \label{eq:direct}
\frac{\phi_{1,\Gamma}}{2}+ K_{L}^{\Gamma}(\phi_{1,\Gamma}) -  V_{L}^{\Gamma} \lambda_1 & = \frac{1}{\epsilon_1} \sum_{k=0}^{N_q}  \frac{q_k}{4\pi|\mathbf{r}_{\Gamma} - \mathbf{r}_k|} \nonumber \\
\frac{\phi_{2,\Gamma}}{2} - K_{Y}^{\Gamma}(\phi_{2,\Gamma}) + V_{Y}^{\Gamma} \lambda_2 & = 0
\end{align}
%
The {\it direct} formulation\cite{YoonLenhoff1990} couples the two expressions of Eq. \eqref{eq:direct} on $\Gamma$, considering the interface conditions. Even though this formulation is poorly conditioned with respect to the mesh size, it can still model large systems when it is preconditioned appropriately.\cite{AltmanBardhanWhiteTidor09,MartinezETal2019,wang2021high} 
The formulation presented by Lu\cite{LuETal2006} takes the normal derivative of \eqref{eq:direct} to couple both $\phi$ and $\partial\phi/\partial\mathbf{n}$ as
%
\begin{align}\label{eq:lu}
    & \frac{\phi_{2,\Gamma}}{2}\left(\frac{\epsilon_1}{\epsilon_2}+1\right) - \left(K_Y^\Gamma - \frac{\epsilon_1}{\epsilon_2}K_L^\Gamma\right)(\phi_{2,\Gamma}) + \left(V_Y^\Gamma - V_L^\Gamma\right)\lambda_2 = \sum_{k=0}^{N_q}  \frac{q_k}{4\pi\epsilon_2|\mathbf{r}_{\Gamma} - \mathbf{r}_k|}
     \nonumber \\
    &\frac{\epsilon_1}{\epsilon_2}\left(W_Y^\Gamma - W_L^\Gamma\right)(\phi_{2,\Gamma}) +  \frac{1}{2}\lambda_2\left(1+\frac{\epsilon_1}{\epsilon_2}\right) + \left(\frac{\epsilon_1}{\epsilon_2}K_Y^{\prime\Gamma} - K_L^{\prime\Gamma}\right)\lambda_2 = \sum_{k=0}^{N_q}  \frac{\partial}{\partial\mathbf{n}_\mathbf{r}}\left(\frac{q_k}{4\pi\epsilon_2|\mathbf{r}_{\Gamma} - \mathbf{r}_k|}\right)
\end{align}
%
The two new integral operators that appear are defined as 
%
\begin{align}\label{eq:adj_hyp}
K^{\prime\Gamma}_{L,Y}(\varphi) = \oint_\Gamma \frac{g_{L,Y}}{\partial\mathbf{n}}(\mathbf{r}_\Gamma,\mathbf{r}')\varphi(\mathbf{r}')d\mathbf{r}'\nonumber\\
W^\Gamma_{L,Y}(\varphi) = - \oint_\Gamma \frac{\partial^2 g_{L,Y}}{\partial\mathbf{n}'\partial\mathbf{n}}(\mathbf{r}_\Gamma,\mathbf{r}')\varphi(\mathbf{r}')d\mathbf{r}'
\end{align}
%
and are called the {\it  adjoint double layer} and {\it hypersingular} operators, respectively. Note that the potential in Eq. \eqref{eq:lu} is evaluated on the exterior. 
In weak form, Eq. \eqref{eq:lu} becomes
%
\begin{align}\label{eq:lu_disc}
&\left< \frac{1}{2}\left(\frac{\epsilon_1}{\epsilon_2}+1\right) I - \left(K_Y^\Gamma - \frac{\epsilon_1}{\epsilon_2}K_L^\Gamma\right)(\phi_{2}), v \right>_{\Gamma} + \left< \left(V_Y^\Gamma - V_L^\Gamma\right) \lambda_2, v \right>_\Gamma = \left( \sum_{k=0}^{N_q}  \frac{q_k}{4\pi\epsilon_2|\mathbf{r}_{\Gamma} - \mathbf{r}_k|}, v \right)_{\Omega_1} \nonumber \\
&\left< \frac{\epsilon_1}{\epsilon_2}\left(W_Y^\Gamma - W_L^\Gamma\right)\phi_{2} \right>_\Gamma + \left< \left(1+\frac{\epsilon_1}{\epsilon_2}\right) + \left(\frac{\epsilon_1}{\epsilon_2}K_Y^{\prime\Gamma} - K_L^{\prime\Gamma}\right)\lambda_2, v\right>_\Gamma = 0
\end{align}
%
where $v$ is a test function, and $\left<\varphi,v\right>_\Gamma = \int_\Gamma \varphi(\mathbf{r})v(\mathbf{r})d\mathbf{r}$ and $\left(\varphi,v\right)_\Omega = \int_\Omega \varphi(\mathbf{r})v(\mathbf{r})d\mathbf{r}$ are the inner products on the surface and domain, respectively. This can be written in matrix form as
%
\begin{align}
Matrix equation
\end{align}
%

Having computed the electrostatic potential with Eq. \eqref{eq:lu_disc}, we obtain the reaction potential ($\phi_r$) in Eq. \eqref{eq:dG} by subtracting out the Coulombic component out of $\phi_1$ in Eq. \eqref{eq:volume_potential}. This gives
%
\begin{align} \label{eq:phi_reac}
\phi_{r} = - K_{L}^{\Omega_1}(\phi_{1,\Gamma}) + V_{L}^{\Omega_1} \left(\frac{\partial}{\partial \mathbf{n}}  \phi_{1,\Gamma}  \right),
\end{align}
%
which is valid as long as $\epsilon_1$ is a constant.

\subsection*{\sffamily \large FEM-BEM coupling}

\begin{itemize}
    \item Description with constant and variable permittivity 
    
BEM reduces the dimension of the problem by using the boundary integral equation, hence its popularity as a numerical solution of  the Poisson-Boltzmann equation in molecular electrostatics. Unfortunately, such advantage comes with the cost. A fundamental solution must be found before the BEM can be applied. There are many linear problems for which fundamental solutions are not known. For Poisson-Boltzmann equation it is a case if we consider the heterogenous permittivity inside the molecule
   \begin{align} \label{eq:pbe_vp}
\nabla \cdot \left(\epsilon_1(\mathbf{x}) \nabla \phi_1(\mathbf{x})\right) &= \sum_{k=1}^{N_q} q_k\delta(\mathbf{x},\mathbf{x}_k) \quad  \mathbf{x} \in \Omega_1\nonumber\\
\left(\nabla^2 - \kappa^2\right)\phi_2(\mathbf{x})  &= 0 \quad\mathbf{x}\in\Omega_2\nonumber\\
\phi_1(\mathbf{x})  = \phi_2(\mathbf{x}),  &\quad \epsilon_1(\mathbf{x})\frac{\partial\phi_1}{\partial\mathbf{n}}(\mathbf{x})  = \epsilon_2\frac{\partial\phi_2}{\partial\mathbf{n}}(\mathbf{x})  \quad \mathbf{x}\in \Gamma. 
\end{align}
For such case finite element methods (FEM) are more suitable.

The coupling of finite element (FEM) and boundary element (BEM) methods is the most widely used approach for solving multi-physical problems on an unbounded domain. It allows to take advantage of both methods. On the one hand, the BEM approximates only boundary conditions, hence it is commonly used for problems involving infinite or semi-infinite domains. On the other hand, the FEM is known for its robustness and universal applicability even for problem of inhomogeneous or non-linear nature.
And that is why, we present two formualtions of FEM-BEM coupling for Poisson-Boltzmann equation.
    
    \item Standard FEM-BEM coupling approach
   
   As mentioned before we will use finite element discretisation for internal problem on domain $\Omega_1$ and boundary elements for external domain $\Omega_2$. The formulation below can be applied for homogeneous and heterogeneous $\epsilon_1$, hence for simplicity we do not distinguish between these cases in the formulation.
    
    We start with the variational formulation of the internal problem. Applying integration by parts for first equation of~\eqref{eq:pbe_vp} for every $v \in H_0^1(\Omega_1)$ we have
\begin{equation}
\label{eq:fem}
 \int_{\Omega_1} \epsilon_1 \nabla \phi_1 : \nabla v ~d\mathbf{x}  - \oint_\Gamma \epsilon_1\partial_n \phi_1 v ds =   \int_{\Omega_1}  \sum_{k=1}^{N_q} q_k\delta(\mathbf{x},\mathbf{x}_k)  v ~d\mathbf{x}.
\end{equation}
For external problem we use BEM and the same direct formulation as in~\eqref{eq:direct}, hence we obtain
\begin{align*}
\frac{\phi_{1,\Gamma}}{2} - K_{Y}^{\Gamma}(\phi_{1,\Gamma}) + \frac{\epsilon_1}{\epsilon_2}V_{Y}^{\Gamma} \left( \frac{\partial}{\partial \mathbf{n}} \phi_{1,\Gamma} \right) & = 0.
\end{align*}

Using the above definition and assuming that $\lambda_{1,\Gamma}  = \frac{\partial}{\partial \mathbf{n}} \phi_{1,\Gamma} $ the coupling problem can be written as follows
\begin{center}
  \textit{Find $ \phi_1 \in H^1(\Omega_1)$ and $\lambda_{1,\Gamma} \in H^{-\frac{1}{2}}(\Gamma)$ such that for all $v \in H^1(\Omega_1)$ and $\zeta \in H^{-\frac{1}{2}}(\Gamma)$}
\begin{equation} 
\label{eq:standard_fem_bem}
 \left\{
 \begin{array}{rcl}
 \int_{\Omega_1} \epsilon_1 \nabla \phi_1 : \nabla v ~d\mathbf{x}  - \oint_\Gamma \epsilon_1\partial_n \phi_1 v ds &=&   \int_{\Omega_1}  \sum_{k=1}^{N_q} q_k\delta(\mathbf{x},\mathbf{x}_k)  v ~d\mathbf{x} \\[3mm] 
  \oint_\Gamma \left(\tfrac{1}{2} - K_{Y}^{\Gamma}\right) \phi_{1,\Gamma} \zeta ds + \frac{\epsilon_1}{\epsilon_2} \oint_\Gamma V_{Y}^{\Gamma} \lambda_{1,\Gamma} \zeta ds &=&0.
  \end{array}
  \right.
\end{equation}
\end{center}


%\begin{align}\label{eq:standard_fem_bem}
% \int_{\Omega_1} \epsilon_1 \nabla \phi_1 : \nabla v ~d\mathbf{x}  - \oint_\Gamma \epsilon_1\partial_n \phi_1 v ds &=   \int_{\Omega_1}  \sum_{k=1}^{N_q} q_k\delta(\mathbf{x},\mathbf{x}_k)  v ~d\mathbf{x} \\
% \oint_\Gamma \frac{\phi_{1,\Gamma}}{2} - K_{Y}^{\Gamma}(\phi_{1,\Gamma}) + \frac{\epsilon_1}{\epsilon_2}V_{Y}^{\Gamma} \left( \lambda_{1,\Gamma} \right) & = 0
%\end{align}


    \item Hybrid FEM-BEM coupling
    
  In the previous section, we focused on the standard formulation. Now, we propose the weak penalty formulation of a couple problem. The discretisation is made by using finite element methods in the domain $\Omega_1$ and boundary integral methods in the domain $\Omega_2$.
  
    The main difference between the standard and hybrid FEM-BEM formulations is addition of hybrid variable $\widetilde{\phi}$ that is a trace of $\phi_1$ and $\phi_2$ on the interface $\Gamma$ ($\widetilde{\phi} = \phi_1 = \phi_2$ on  $\Gamma$). Both FEM and BEM subproblems are modified to include the hybrid variable by adding some terms that enforce the equality of it with the trace of $\phi_1$ and $\phi_2$.
    
    The standard formulation of interior problem~\eqref{eq:fem} can be rewritten as follows
\begin{align*}
 \int_{\Omega_m} \frac{\epsilon_1(\mathbf{x})}{\epsilon_2} \nabla \phi_1 : \nabla v d\mathbf{x} -  \oint_\Gamma \frac{\epsilon_1(\mathbf{x})}{\epsilon_2}  \partial_n \phi_1 v ds
  & \\
 -  \oint_\Gamma \frac{\epsilon_1(\mathbf{x})}{\epsilon_2} \partial_n v (\phi_1 - \widetilde{\phi}) ds
  + \tfrac{\tau_F}{h} \oint_\Gamma \frac{\epsilon_1(\mathbf{x})}{\epsilon_2} (\phi_1 - \widetilde{\phi}) v ds & = \int_{\Omega_1}  \sum_{k=1}^{N_q} q_k\delta(\mathbf{x},\mathbf{x}_k)   v ~d\mathbf{x}.
\end{align*}
With every iteration we are solving above problem for given $\widetilde{\phi}$ and hence obtaining the solution $ \phi_1$.
%We are using FEniCS finite element library, hence the above formulation is more sumilar to the implementation.

In the case of exterior problem of~\eqref{eq:pbe_vp} we use Yukawa kernel and 
%matrix form, for clarity and similarity with BEMpp implementation. In this case we consider linearised formulation of the Poisson-Boltzman equation that means our operators are built as for modified Helmholtz equation with wavenumber $\kappa$.
for given $\widetilde{\phi}$, with each iteration we are solving the following system
\begin{align*}
V_{Y}^{\Gamma} \lambda_{2,\Gamma}  - \left( \tfrac{1}{2}Id + K_{Y}^{\Gamma}  \right) \phi_2 &= - \widetilde{\phi},  \\
 \left( \tfrac{1}{2} Id +  K_{Y}^{',\Gamma}\right)  \lambda_{2,\Gamma} + \left(W_{Y}^{\Gamma} + \tau_B Id\right)  \phi_2  &= \tau_B \widetilde{\phi},
\end{align*}
where $K'$ and $W$ are the adjoint double-layer potentials and hypersingular operator for the Yukawa kernel.

Both, the interior and exterior problems have unique solutions for given $\widetilde{\phi}$. In order to find $\widetilde{\phi}$ we solve the following problem on $\Gamma$
\begin{equation*}
\tfrac{\tau_F}{h} \left( \phi_1 - \widetilde{\phi}\right) + \tau_B \left( \phi_2 - \widetilde{\phi}\right)  - \left(\frac{\epsilon_1}{\epsilon_2} \frac{\partial}{\partial \mathbf{n}} \phi_1 -\lambda_{2,\Gamma} \right)  = 0.
\end{equation*}
\end{itemize}
