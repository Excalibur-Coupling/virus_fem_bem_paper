\subsection*{\sffamily \large The implicit solvent model}

The implicit solvent model can be described mathematically as a coupled system of partial differential equations, where the Poisson-Boltzmann governs in the solvent region ($\Omega_1$ in Figure XX), and the Poisson equation in the solute region ($\Omega_2$ in Figure XX). These regions are interfaced by the molecular surface ($\Gamma$), where the potential ($\phi$) and electric displacement ($\epsilon\partial\phi/\partial\mathbf{n}$) are continuous. 
%
\begin{align}\label{eq:pbe}
\nabla^2\phi_1(\mathbf{x}) &= \tfrac{1}{\epsilon_1}\sum_{k=1}^{N_q} q_k\delta(\mathbf{x},\mathbf{x}_k) \quad  \mathbf{x} \in \Omega_1\nonumber\\
\left(\nabla^2 - \kappa^2\right)\phi_2(\mathbf{x})  &= 0 \quad\mathbf{x}\in\Omega_2\nonumber\\
\phi_1(\mathbf{x})  = \phi_2 (\mathbf{x}), &\quad \epsilon_1\frac{\partial\phi_1}{\partial\mathbf{n}}(\mathbf{x})  = \epsilon_2\frac{\partial\phi_2}{\partial\mathbf{n}}(\mathbf{x})  \quad \mathbf{x}\in \Gamma. 
\end{align}
%
Here, $\epsilon_1$ and $\epsilon_2$ are the dielectric constants in the solute and solvent, respectively, $\kappa$ is the inverse of the Debye length, related with the salt concentration, and $q_k$ are the values of the partial charges, located at $\mathbf{x}_k$.

The electrostatic potential in $\Omega_1$ can be further decomposed into singular and regular components as $\phi_1 = \phi_c + \phi_r$, where $\phi_c$ is the solution to
%
\begin{align}\label{eq:phic}
\nabla^2\phi_c(\mathbf{x}) &= \tfrac{1}{\epsilon}\sum_{k=1}^{N_q}q_k\delta(\mathbf{x},\mathbf{x}_k) \quad \mathbf{x}\in\Omega_1\cup\Omega_2\nonumber\\
\phi_c(\mathbf{x})&=0 \quad \text{ as } |\mathbf{x}|\to\infty
\end{align}

Physically, $\phi_c$ can be interpreted as the Coulomb-type potential from the point charges, whereas $\phi_r$, also known as reaction potential, is originated by the polarization of the solvent and reorganization of the free ions. 
Usually, $\epsilon_1$ is considered a constant value, yielding an analytical expression for $\phi_c$, however, this is not the general case.

There are regularized versions of Equation \eqref{eq:pbe} \cite{LuZhouHolstMcCammon2008,LeeGengZhao2021} which are widely used to numerically solve the Poisson-Boltzmann equation with finite element or finite difference methods.
However, here we use the standard formulation in Equation \eqref{eq:pbe}, as it offers more flexibility when dealing with, for example, variable permitivitties.

A common quantity of interest in implicit solvent models is the solvation free energy, which the change in Gibbs free energy as the molecule moves from vacuum into the solvent. Considering the charge distribution $\rho$ consists of point charges, this can be calculated as
%
\begin{equation}\label{eq:dG} 
\Delta G_{solv} = \tfrac{1}{2}\int_{\Omega_1} \rho(\mathbf{x})\phi_{r}(\mathbf{x}) = \tfrac{1}{2}\sum_{k=1}^{N_q} q_k\phi_r(\mathbf{x_k})
\end{equation}

\subsection*{\sffamily \large Numerical solution of the Poisson-Boltzmann equation}

\subsubsection*{\sffamily \normalsize BEM-BEM coupling}

The boundary element method (BEM) is a standard tool for the numerical solution of the Poisson-Boltzmann equation in molecular electrostatics.~\cite{ZauharMorgan1985, Shaw1985} This was implemented in numerous codes, such as AFMPB,~\cite{LuETal2006} TABI,~\cite{GengKrasny2013} PyGBe,~\cite{CooperBardhanBarba2014,cooper2016pygbe} and more recently, with Bempp-cl.~\cite{search2022towards} 

There are several possible boundary integral formulations of Equation \eqref{eq:pbe}.~\cite{search2022towards} The simplest form was presented by Yoon Âºand Lenhoff in 1991,~\cite{YoonLenhoff1990} known as the \emph{direct} formulation, however, the resulting system is usually ill-conditioned. Here, we use the better conditioned formulation presented by Lu and co-workers.~\cite{LuETal2006,LuETal2009,debuhr2016dashmm}
Applying Green's second identity to Equation \eqref{eq:pbe} we get 
%
\begin{align} \label{eq:volume_potential}
\phi_{1}(\mathbf{x}_{\Omega_1})+ K_{L}^{\Omega_1}\phi_1 -  V_{L}^{\Omega_1} \lambda_2^1 & = \tfrac{1}{\epsilon_1} \sum_{k=0}^{N_q}  \frac{q_k}{4\pi|\mathbf{x}_{\Omega_1} - \mathbf{x}_k|}  \quad \text{on $\Omega_1$,} \nonumber \\
\phi_{2}(\mathbf{x}_{\Omega_2}) - K_{Y}^{\Omega_2}\phi_2 + V_{Y}^{\Omega_2} \lambda_2& = 0 \quad \text{on $\Omega_2$,}
\end{align}
%
where $\mathbf{x}_\Omega$ is evaluated anywhere in the correspoding domain, except $\Gamma$, and $\phi_1 = \phi_1(\mathbf{x}_\Gamma)$ and $\phi_2 = \phi_2(\mathbf{x}_\Gamma)$ are the potentials on $\Gamma$ as we approach from $\Omega_1$ and $\Omega_2$, respectively. For convenience, we call the normal derivative on the interface ({\it ie.} the Neumann trace) $\lambda=\left(\frac{\partial}{\partial \mathbf{n}}  \phi_{\Gamma}  \right)$. $K$ and $V$ are the double- and single-layer potentials for the Laplace (subscript $L$) and Yukawa (subscript $Y$, also known as modified Helmholtz) kernels
%
\begin{align}\label{eq:single_double}
V^D \varphi (\mathbf{x}) = \oint_\Gamma g_i(\mathbf{x},\mathbf{x}')\varphi(\mathbf{x}')d\mathbf{x}'\nonumber\\
K^D \varphi (\mathbf{x}) = \oint_\Gamma \frac{\partial g_i}{\partial\mathbf{n}'}(\mathbf{x},\mathbf{x}')\varphi(\mathbf{x}')d\mathbf{x}',\nonumber\\
\end{align}
%
where $D \in \{\Omega_1, \Omega_2, \Gamma\}$, $i \in \{L,Y\}$, $\varphi(\mathbf{x})$ can be any distribution over $\Gamma$, and 
%
\begin{align}\label{eq:green_func}
g_L(\mathbf{x},\mathbf{x}')=\frac{1}{4\pi|\mathbf{x}-\mathbf{x}'|} \nonumber \\
g_Y(\mathbf{x},\mathbf{x}')=\frac{e^{-\kappa|\mathbf{x}-\mathbf{x}'|}}{4\pi|\mathbf{x}-\mathbf{x}'|}
\end{align}
%
are the free-space Green's function of the Laplace and linearized Poisson-Boltzmann equations, respectively. 

If we take the limit of Eq. \eqref{eq:volume_potential} as $\mathbf{x}_{\Omega}$ approaches $\Gamma$, we get
%
\begin{align} \label{eq:direct}
\tfrac{\phi_1}{2}+ K_{L}^{\Gamma}\phi_1 -  V_{L}^{\Gamma} \lambda_2^1 & = \tfrac{1}{\epsilon_1} \sum_{k=0}^{N_q}  \frac{q_k}{4\pi|\mathbf{x}_{\Gamma} - \mathbf{x}_k|} \nonumber \\
\tfrac{\phi_2}{2} - K_{Y}^{\Gamma}\phi_2 + V_{Y}^{\Gamma} \lambda_2 & = 0
\end{align}
%
The {\it direct} formulation\cite{YoonLenhoff1990} couples the two expressions of Eq. \eqref{eq:direct} on $\Gamma$, considering the interface conditions. Even though this formulation is poorly conditioned with respect to the mesh size, it can still model large systems when it is preconditioned appropriately.\cite{AltmanBardhanWhiteTidor09,MartinezETal2019,wang2021high} 
The formulation presented by Lu\cite{LuETal2006} takes the normal derivative of \eqref{eq:direct} to couple both $\phi$ and $\partial\phi/\partial\mathbf{n}$ as
%
\begin{align}\label{eq:lu}
    & \tfrac{\phi_2}{2}\left(1+\tfrac{\epsilon_1}{\epsilon_2}\right) - \left(K_Y^\Gamma - \tfrac{\epsilon_1}{\epsilon_2}K_L^\Gamma\right)\phi_2 + \left(V_Y^\Gamma - V_L^\Gamma\right)\lambda_2 = \sum_{k=0}^{N_q}  \frac{q_k}{4\pi\epsilon_2|\mathbf{x}_{\Gamma} - \mathbf{x}_k|}
     \nonumber \\
    &\tfrac{\epsilon_1}{\epsilon_2}\left(W_Y^\Gamma - W_L^\Gamma\right)\phi_2 +  \tfrac{\lambda_2}{2}\left(1+\tfrac{\epsilon_1}{\epsilon_2}\right) + \left(\tfrac{\epsilon_1}{\epsilon_2}K_Y^{\prime\Gamma} - K_L^{\prime\Gamma}\right)\lambda_2 = \sum_{k=0}^{N_q}  \frac{\partial}{\partial\mathbf{n}_\mathbf{x}}\left(\frac{q_k}{4\pi\epsilon_2|\mathbf{x}_{\Gamma} - \mathbf{x}_k|}\right)
\end{align}
%
The two new integral operators that appear are defined as 
%
\begin{align}
\label{eq:adj_hyp}
K^{\prime\Gamma}_i\varphi (\mathbf{x}) = \oint_\Gamma \frac{g_i}{\partial\mathbf{n}}(\mathbf{x}_\Gamma,\mathbf{x}')\varphi(\mathbf{x}')d\mathbf{x}'\nonumber\\
W^\Gamma_i\varphi (\mathbf{x}) = - \oint_\Gamma \frac{\partial^2 g_i}{\partial\mathbf{n}'\partial\mathbf{n}}(\mathbf{x}_\Gamma,\mathbf{x}')\varphi(\mathbf{x}')d\mathbf{x}'
\end{align}
where $i \in \{L,Y\}$, 
and are called the {\it  adjoint double layer} and {\it hypersingular} operators, respectively. Note that the potential in Eq. \eqref{eq:lu} is evaluated on the exterior. 
In weak form, Eq. \eqref{eq:lu} becomes
%
\begin{align}\label{eq:lu_disc}
&\left< \left(1+\tfrac{\epsilon_1}{\epsilon_2}\right) \tfrac{\phi_{2}}{2} - \left(K_Y^\Gamma - \tfrac{\epsilon_1}{\epsilon_2}K_L^\Gamma\right)\phi_{2}, v \right>_{\Gamma} + \left< \left(V_Y^\Gamma - V_L^\Gamma\right) \lambda_2, v \right>_\Gamma = \left< \sum_{k=0}^{N_q}  f_k, v \right>_{\Gamma} \nonumber \\
&\left< \tfrac{\epsilon_1}{\epsilon_2}\left(W_Y^\Gamma - W_L^\Gamma\right)\phi_{2}, \zeta \right>_\Gamma + \left<  \left(1+\tfrac{\epsilon_1}{\epsilon_2}\right) \tfrac{\lambda_2}{2} + \left(\tfrac{\epsilon_1}{\epsilon_2}K_Y^{\prime\Gamma} - K_L^{\prime\Gamma}\right)\lambda_2, \zeta\right>_\Gamma = \left< \sum_{k=0}^{N_q}  \frac{\partial}{\partial\mathbf{n}_\mathbf{x}} f_k, \zeta \right>_{\Gamma}
\end{align}
%
where $v, \zeta$ are test functions, $\left<\varphi,v\right>_\Gamma = \int_\Gamma \varphi(\mathbf{x})v(\mathbf{x})d\mathbf{x}$ %and $\left(\varphi,v\right)_\Omega = \int_\Omega \varphi(\mathbf{x})v(\mathbf{x})d\mathbf{x}$ are 
is the inner products on the surface% and domain, respectively
and $f_k := \frac{q_k}{4\pi\epsilon_2|\mathbf{x}_{\Gamma} - \mathbf{x}_k|}$.

We introduce below the matrix formulation. Let $\vec{\phi}_2 := [\phi_2^1, \dots, \phi_2^k]^T$ be the vector of canonical basis
functions of $W_{h}^{k}$ and  $\vec{\lambda}_2 := [\lambda_2^1, \dots, \lambda_2^l]^T$ - the vector of canonical basis
functions of $\Lambda_{h}^{l}$. We define the following matrices associated with the corresponding bilinear forms
\begin{align*}
\widetilde{K}_{\alpha \beta} = \left<\left(K_Y^\Gamma - \tfrac{\epsilon_1}{\epsilon_2}K_L^\Gamma\right) \phi^{\alpha}_2, \ \lambda^{\beta}_2 \right>_{\Gamma}
 &,&
\widetilde{V}_{\alpha \beta} = \left<\left(V_Y^\Gamma - V_L^\Gamma\right) \lambda^{\alpha}_2, \ \lambda^{\beta}_2 \right>_{\Gamma}, \\
\widetilde{W}_{\alpha \beta} = \left<\left(W_Y^\Gamma - W_L^\Gamma\right) \phi^{\alpha}_2, \ \phi^{\beta}_2 \right>_{\Gamma}
 &,&
\widetilde{K'}_{\alpha \beta} = \left<\left(\tfrac{\epsilon_1}{\epsilon_2}K_Y^{\prime\Gamma} - K_L^{\prime\Gamma}\right) \lambda^{\alpha}_2, \ \phi^{\beta}_2 \right>_{\Gamma},
\end{align*}
and vectors associated with the corresponding linear forms
\begin{align*}
\vec{f}_{\beta} = \left< \sum_{k=0}^{N_q}  \frac{q_k}{4\pi\epsilon_2|\mathbf{x}_{\Gamma} - \mathbf{x}_k|},   \phi^{\beta}_1  \right>_{\Gamma} &,& \vec{\partial f}_{\beta} = \left< \sum_{k=0}^{N_q}  \frac{\partial}{\partial\mathbf{n}_\mathbf{x}}\left(\frac{q_k}{4\pi\epsilon_2|\mathbf{x}_{\Gamma} - \mathbf{x}_k|}\right),   \phi^{\beta}_1  \right>_{\Gamma}.
\end{align*}

Using the above definition the discrete problem~\eqref{eq:fem_bem_disctrete} can be written in the following matrix form
\begin{align*}
\begin{bmatrix}
 \tfrac12 \left(1+\tfrac{\epsilon_1}{\epsilon_2}\right) I - \widetilde{K}  & \widetilde{V}  \\  
 \tfrac{\epsilon_1}{\epsilon_2} \widetilde{W} & \tfrac12 \left(1+\tfrac{\epsilon_1}{\epsilon_2}\right) I + \widetilde{K'}
\end{bmatrix}
\begin{bmatrix}
\vec{\phi}_2 \\
\vec{\lambda}_2 
\end{bmatrix}
= 
\begin{bmatrix}
\vec{f} \\  
\vec{\partial f}
\end{bmatrix}.
\end{align*}
%

Having computed the electrostatic potential with Eq. \eqref{eq:lu_disc}, we obtain the reaction potential ($\phi_r$) in Eq. \eqref{eq:dG} by subtracting out the Coulombic component out of $\phi_1$ in Eq. \eqref{eq:volume_potential}. This gives
%
\begin{align} \label{eq:phi_reac}
\phi_{r} = - K_{L}^{\Omega_1}(\phi_1) + V_{L}^{\Omega_1} \left(\frac{\partial}{\partial \mathbf{n}}  \phi_1  \right),
\end{align}
%
which is valid as long as $\epsilon_1$ is a constant.

\subsection*{\sffamily \normalsize FEM-BEM coupling}

{\sffamily \small Description with constant and variable permittivity} 

BEM reduces the dimension of the problem by using the boundary integral equation, hence its popularity as a numerical solution of  the Poisson-Boltzmann equation in molecular electrostatics. Unfortunately, such advantage comes with the cost. A fundamental solution must be found before the BEM can be applied. There are many linear problems for which fundamental solutions are not known. For Poisson-Boltzmann equation it is a case if we consider the heterogenous permittivity inside the molecule
   \begin{align} \label{eq:pbe_vp}
\nabla \cdot \left(\epsilon_1(\mathbf{x}) \nabla \phi_1(\mathbf{x})\right) &= \sum_{k=1}^{N_q} q_k\delta(\mathbf{x},\mathbf{x}_k) \quad  \mathbf{x} \in \Omega_1\nonumber\\
\left(\nabla^2 - \kappa^2\right)\phi_2(\mathbf{x})  &= 0 \quad\mathbf{x}\in\Omega_2\nonumber\\
\phi_1(\mathbf{x})  = \phi_2(\mathbf{x}),  &\quad \epsilon_1(\mathbf{x})\frac{\partial\phi_1}{\partial\mathbf{n}}(\mathbf{x})  = \epsilon_2\frac{\partial\phi_2}{\partial\mathbf{n}}(\mathbf{x})  \quad \mathbf{x}\in \Gamma. 
\end{align}
For such case finite element methods (FEM) are more suitable.

The coupling of finite element (FEM) and boundary element (BEM) methods is the most widely used approach for solving multi-physical problems on an unbounded domain. It allows to take advantage of both methods. On the one hand, the BEM approximates only boundary conditions, hence it is commonly used for problems involving infinite or semi-infinite domains. On the other hand, the FEM is known for its robustness and universal applicability even for problem of inhomogeneous or non-linear nature.
And that is why, we present two formulations of FEM-BEM coupling for Poisson-Boltzmann equation.
    
{\sffamily \small Standard FEM-BEM coupling approach}
   
   As mentioned before we will use finite element discretisation for internal problem on domain $\Omega_1$ and boundary elements for external domain $\Omega_2$. The formulation below can be applied for homogeneous and heterogeneous $\epsilon_1$, hence for simplicity we do not distinguish between these cases in the formulation.
    
    We start with the variational formulation of the internal problem. Applying integration by parts for first equation of~\eqref{eq:pbe_vp} for every $v \in H_0^1(\Omega_1)$ we have
\begin{equation}
\label{eq:fem}
 \left( \epsilon_1 \nabla \phi_1, \nabla v \right)_{\Omega_1}  -  \left<  \epsilon_1\partial_n \phi_1, v \right>_\Gamma =  \left( \sum_{k=1}^{N_q} q_k\delta(\mathbf{x},\mathbf{x}_k),  v\right)_{\Omega_1},
\end{equation}
where $v$ is a test function, and $\left<\varphi,v\right>_\Gamma = \int_\Gamma \varphi(\mathbf{x})v(\mathbf{x})d\mathbf{x}$ and $\left(\varphi,v\right)_{\Omega_1} = \int_{\Omega_1} \varphi(\mathbf{x})v(\mathbf{x})d\mathbf{x}$ are the inner products on the surface and domain, respectively.
For external problem we use BEM and the same direct formulation as in~\eqref{eq:direct}, hence we obtain
\begin{align*}
\tfrac{\phi_1}{2} - K_{Y}^{\Gamma}(\phi_1) + \tfrac{\epsilon_1}{\epsilon_2}V_{Y}^{\Gamma} \left( \frac{\partial}{\partial \mathbf{n}} \phi_1 \right) & = 0.
\end{align*}

Using the above definition and assuming that $\lambda_2  = \frac{\partial}{\partial \mathbf{n}} \phi_1 $ the coupling problem can be written as follows
\begin{center}
  \textit{Find $ \phi_1 \in H^1(\Omega_1)$ and $\lambda_2 \in H^{-\frac{1}{2}}(\Gamma)$ such that for all $v \in H^1(\Omega_1)$ and $\zeta \in H^{-\frac{1}{2}}(\Gamma)$}
\begin{equation} 
\label{eq:standard_fem_bem}
 \left\{
 \begin{array}{rcl}
 \left(  \epsilon_1 \nabla \phi_1, \nabla v \right)_{\Omega_1}  - \left< \epsilon_1 \lambda_2, v \right>_\Gamma &=&   \left(  \sum_{k=1}^{N_q} q_k\delta(\mathbf{x},\mathbf{x}_k),  v \right)_{\Omega_1} \\[3mm] 
  \left< \left(\tfrac{1}{2} I - K_{Y}^{\Gamma}\right) \phi_1, \zeta \right>_\Gamma + \tfrac{\epsilon_1}{\epsilon_2} \left< V_{Y}^{\Gamma} \lambda_2, \zeta \right>_\Gamma &=&0.
  \end{array}
  \right.
\end{equation}
\end{center}


%\begin{align}\label{eq:standard_fem_bem}
% \int_{\Omega_1} \epsilon_1 \nabla \phi_1 : \nabla v ~d\mathbf{x}  - \oint_\Gamma \epsilon_1\partial_n \phi_1 v ds &=   \int_{\Omega_1}  \sum_{k=1}^{N_q} q_k\delta(\mathbf{x},\mathbf{x}_k)  v ~d\mathbf{x} \\
% \oint_\Gamma \tfrac{\phi_1}{2} - K_{Y}^{\Gamma}(\phi_1) + \tfrac{\epsilon_1}{\epsilon_2}V_{Y}^{\Gamma} \left( \lambda_2^1 \right) & = 0
%\end{align}

We introduce below the matrix formulation. Let $\vec{\phi}_1 := [\phi_1^1, \dots, \phi_1^j]^T$ be the vector of canonical basis
functions of the finite element space $V_{h}^{j}$, %$\vec{\phi}_2 := [\phi_2^1, \dots, \phi_2^k]^T$ - the vector of canonical basis functions of $W_{h}^{k}$,  
$\vec{\lambda}_2 := [\lambda_2^1, \dots, \lambda_2^l]^T$ - the vector of canonical basis
functions of $\Lambda_{h}^{l}$. % and $\vec{\widetilde{\phi}} := [\widetilde{\phi}^1, \dots, \widetilde{\phi}^m]^T$ be the vector of canonical basis functions of  $M_{h}^{m}$
% $T:\Omega_1 \rightarrow \Gamma$ and $E:\Gamma \rightarrow \Omega_1$ trace and extendable operators respectively.
We define the following matrices  associated with the corresponding bilinear forms
\begin{align*}
A_{\alpha \beta} = \left(\nabla \phi_1, \nabla \phi_1^{\beta} \right)_{\Omega_1}  
&,&
M_{\alpha \beta} = \left< \widetilde{\phi}^{\alpha}, \ \lambda^{\beta}_2 \right>_{\Gamma}, \\
K_{\alpha \beta} = \left<K_{Y}^{\Gamma} \phi^{\alpha}_1, \ \lambda^{\beta}_2 \right>_{\Gamma}
 &,&
V_{\alpha \beta} = \left<V_{Y}^{\Gamma} \lambda^{\alpha}_2, \ \lambda^{\beta}_2 \right>_{\Gamma}, 
\end{align*}
and vector associated with the corresponding linear form
\begin{equation*}
\vec{f}_{\beta} := \left(  \sum_{k=1}^{N_q} q_k\delta(\mathbf{x},\mathbf{x}_k),  \phi_1^{\beta} \right)_{\Omega_1}.
\end{equation*}
Using the above definition the discrete problem~\eqref{eq:standard_fem_bem} can be written in the following matrix form
\begin{align*}
\begin{bmatrix}
\epsilon_1 A &  - \epsilon_1 M^T \\  
\left(\tfrac12 I + K \right) &  \tfrac{\epsilon_1}{\epsilon_2} V 
\end{bmatrix}
\begin{bmatrix}
\vec{\phi}_1 \\  
\vec{\lambda}_2
\end{bmatrix}
= 
\begin{bmatrix}
\vec{f} \\  
0
\end{bmatrix}.
\end{align*}


{\sffamily \small Hybrid FEM-BEM coupling}
    
  In the previous section, we focused on the standard formulation. Now, we propose the weak penalty formulation of a couple problem. The discretisation is made by using finite element methods in the domain $\Omega_1$ and boundary integral methods in the domain $\Omega_2$.
  
    The main difference between the standard and hybrid FEM-BEM formulations is addition of hybrid variable $\widetilde{\phi}$ that is a trace of $\phi_1$ and $\phi_2$ on the interface $\Gamma$ ($\widetilde{\phi} = \phi_1 = \phi_2$ on  $\Gamma$). Both FEM and BEM subproblems are modified to include the hybrid variable by adding some terms that enforce the equality of it with the trace of $\phi_1$ and $\phi_2$.
    
    The standard formulation of interior problem~\eqref{eq:fem} can be rewritten as follows
\begin{align*}
 \left(  \tfrac{\epsilon_1(\mathbf{x})}{\epsilon_2} \nabla \phi_1, \nabla v \right)_{\Omega_1} -  \left<  \tfrac{\epsilon_1(\mathbf{x})}{\epsilon_2}  \partial_n \phi_1, v \right>_\Gamma
  & \\
 -  \left<  \tfrac{\epsilon_1(\mathbf{x})}{\epsilon_2} \partial_n v, (\phi_1 - \widetilde{\phi}) \right>_\Gamma
  + \tfrac{\tau_F}{h} \left<  \tfrac{\epsilon_1(\mathbf{x})}{\epsilon_2} (\phi_1 - \widetilde{\phi}), v \right>_\Gamma & = \left(  \sum_{k=1}^{N_q} q_k\delta(\mathbf{x},\mathbf{x}_k),   v \right)_{\Omega_1}.
\end{align*}
With every iteration we are solving above problem for given $\widetilde{\phi}$ and hence obtaining the solution $ \phi_1$.
%We are using FEniCS finite element library, hence the above formulation is more sumilar to the implementation.

In the case of exterior problem of~\eqref{eq:pbe_vp} we use Yukawa kernel and 
%matrix form, for clarity and similarity with BEMpp implementation. In this case we consider linearised formulation of the Poisson-Boltzman equation that means our operators are built as for modified Helmholtz equation with wavenumber $\kappa$.
for given $\widetilde{\phi}$, with each iteration we are solving the following system
\begin{align*}
V_{Y}^{\Gamma} \lambda_2  - \left( \tfrac{1}{2}I + K_{Y}^{\Gamma}  \right) \phi_2 &= - \widetilde{\phi},  \\
 \left( \tfrac{1}{2} I +  K_{Y}^{'\Gamma}\right)  \lambda_2 + \left(W_{Y}^{\Gamma} + \tau_B I\right)  \phi_2  &= \tau_B \widetilde{\phi},
\end{align*}
where $K'$ and $W$ are the adjoint double-layer potentials and hypersingular operator for the Yukawa kernel.

Both, the interior and exterior problems have unique solutions for given $\widetilde{\phi}$. In order to find $\widetilde{\phi}$ we solve the following problem on $\Gamma$
\begin{equation*}
\tfrac{\tau_F}{h} \left( \phi_1 - \widetilde{\phi}\right) + \tau_B \left( \phi_2 - \widetilde{\phi}\right)  - \left(\tfrac{\epsilon_1}{\epsilon_2} \frac{\partial}{\partial \mathbf{n}} \phi_1 -\lambda_2 \right)  = 0.
\end{equation*}

We introduce below the matrix formulation and algorithm used for implementation. Let $\vec{\phi}_1 := [\phi_1^1, \dots, \phi_1^j]^T$ be the vector of canonical basis
functions of the finite element space $V_{h}^{j}$, $\vec{\phi}_2 := [\phi_2^1, \dots, \phi_2^k]^T$ - the vector of canonical basis
functions of $W_{h}^{k}$,  $\vec{\lambda}_2 := [\lambda_2^1, \dots, \lambda_2^l]^T$ - the vector of canonical basis
functions of $\Lambda_{h}^{l}$ and $\vec{\widetilde{\phi}} := [\widetilde{\phi}^1, \dots, \widetilde{\phi}^m]^T$ be the vector of canonical basis
functions of  $M_{h}^{m}$. We define the following matrices associated with the corresponding bilinear forms
\begin{center}
$A_{\alpha \beta} = \left(  \tfrac{\epsilon_1(\mathbf{x})}{\epsilon_2} \nabla \phi^{\alpha}_1, \nabla \phi^{\beta}_1  \right)_{\Omega_1}  - \left< \partial_n \phi^{\alpha}_1 ,  \phi^{\beta}_1 \right>_{\Gamma}   - \left< \phi^{\alpha}_1  , \ \partial_n \phi^{\beta}_1  \right>_{\Gamma}   + \tfrac{\tau_F}{h} \left< \phi^{\alpha}_1 ,\ \phi^{\beta}_1  \right>_{\Gamma}, $                                                                                                                                                                                                                                                                                                        \end{center}
\vspace{-15pt}
\begin{align*}
B_{\alpha \beta} = \left< \widetilde{\phi}^{\alpha}, \ \partial_n \phi^{\beta}_1  \right>_{\Gamma} - \tfrac{\tau_F}{h} \left< \widetilde{\phi}^{\alpha},\ \phi^{\beta}_1  \right>_{\Gamma} 
 &,& 
M_{\alpha \beta} =\left< \widetilde{\phi}^{\alpha}, \ \lambda^{\beta}_2 \right>_{\Gamma}, \\
K'_{\alpha \beta} = \left<K_{Y}^{'\Gamma} \lambda^{\alpha}_2, \ \phi^{\beta}_2 \right>_{\Gamma}
 &,&
V_{\alpha \beta} = \left<V_{Y}^{\Gamma} \lambda^{\alpha}_2, \ \lambda^{\beta}_2 \right>_{\Gamma}, \\
W_{\alpha \beta} = \left< W_{Y}^{\Gamma} \phi^{\alpha}_2, \ \phi^{\beta}_2 \right>_{\Gamma}
 &,&
K_{\alpha \beta} = -\left<K_{Y}^{\Gamma} \phi^{\alpha}_2, \ \lambda^{\beta}_2 \right>_{\Gamma},
\end{align*}
and vector associated with the corresponding linear form
\begin{equation*}
\vec{f}_{\beta} = \left(  \sum_{k=1}^{N_q} q_k\delta(\mathbf{x},\mathbf{x}_k),   \phi^{\beta}_1 \right)_{\Omega_1}.
\end{equation*}

Using the above definition the discrete problem~\eqref{eq:fem_bem_disctrete} can be written in the following matrix form
\begin{align*}
\begin{bmatrix}
A & 0 & 0 & B \\  
0 & \tfrac12 I + K &  V & - \tau_B I \\
0 & \tau_B I + W & \tfrac12 I - K' & M \\
B^T & - \tau_B I & -M^T & \left(\tfrac{\tau_F}{h} + \tau_B\right) I
\end{bmatrix}
\begin{bmatrix}
\vec{\phi}_1 \\  
\vec{\phi}_2 \\
\vec{\lambda}_2 \\
\vec{\widetilde{\phi}}
\end{bmatrix}
= 
\begin{bmatrix}
\vec{f} \\  
0 \\
0 \\
0
\end{bmatrix}.
\end{align*}
To solve this system we use the Schur complement and the Steklov-Poincar\'e  operator to eliminate all variables except the hybrid one as follows
\begin{align}
\label{eq:Schur}
\left(\left(\tfrac{\tau_F}{h} + \tau_B\right) I  - B^T A^{-1} B + \begin{bmatrix} \tau_B I & M^T \end{bmatrix} \begin{bmatrix}
\tfrac12 I + K &  V  \\
\tau_B I + W & \tfrac12 I - K'
\end{bmatrix}^{-1}
\begin{bmatrix}
 -\tau_B I \\
M
\end{bmatrix} 
\right) \vec{\widetilde{\phi}}
= -B^T A^{-1} \vec{f}
\end{align}


In our experiment tests we consider $\mathcal{V}_h\times \Lambda_{h}^{l} \times M_{h}^{m}$ with $j = k = m = l = 1$. We let the interface meshes  coincide with the trace mesh of volume mesh on $\Gamma$. %As we know from our experiments as well as the one performed in~\cite{MR3945809}, there is a flexibility with the  choice of positive parameter $\tau_B$, hence for simplicity we use $\tau_B = 1$.

For our experiments we use two numerical softwares: FEniCS~\cite{AlnaesBlechta2015a} and Bempp~\cite{SmigajEtAl2015}.
We use the solution of interior and exterior Dirichlet boundary value problems to construct a Schur complement system~\eqref{eq:Schur}.
The solution $\vec{\widetilde{\phi}}$ on $\Gamma$ of the eliminated system~\eqref{eq:Schur} is obtained using the nested MINRES method~\cite{}. Although one can use direct solvers to solve the interior and exterior Dirichlet boundary value problems, we here used preconditioned iterative solvers suitable for large scale applications.  The interior Dirichlet boundary value problem is solved by using FEniCS and generalized minimal residual method (GMRES)~\cite{MR848568} without and with incomplete Cholesky preconditioner. The discrete exterior problem is solved by using the GMRES without or with mass matrix preconditioner to solve in Bempp the external Dirichlet boundary value problem.
The tolerance of the iterative solvers is chosen to be not greater the $10^{-6}$. 
Overall, the algorithm has the following structure:
\begin{enumerate}
 \item Assemble the FE weak form in FEniCS and define matrix-vector formulation  using GMRES with tolerance $10^{-8}$
 \begin{equation*}
 LHS_{FEM} := B^T A^{-1} B \vec{\widetilde{\phi}} .
 \end{equation*}
 \item Assemble BE operators in BEMpp and define matrix-vector formulation 
using GMRES with tolerance $10^{-8}$
 \begin{equation*}
 LHS_{BEM} := \begin{bmatrix} \tau_B I & M^T \end{bmatrix} \begin{bmatrix}
\tfrac12 I + K &  V  \\
\tau_B I + W & \tfrac12 I - K'
\end{bmatrix}^{-1}
\begin{bmatrix}
 -\tau_B I \\
M
\end{bmatrix} 
\vec{\widetilde{\phi}}  .
 \end{equation*}
 \item Combine matrix-vector formulation of interior and exterior problem in the lhs of~\eqref{eq:Schur}.
 \item Build rhs of~\eqref{eq:Schur}
 \begin{equation*}
 RHS := -B^T A^{-1} \vec{f}.
 \end{equation*}
 \item Solve the reduced system using MINRES with tolerance $10^{-6}$.
 \begin{equation*}
 \left(\tfrac{\tau_F}{h} + \tau_B\right) I \vec{\widetilde{\phi}}  - LHS_{FEM} + LHS_{BEM} = RHS .
 \end{equation*}
 \item Use solution $\vec{\widetilde{\phi}}$ to obtain the solution $\vec{\phi}$ by solving the interior problem or to obtain the solution $\begin{bmatrix} \vec{\phi}_2 \\ \vec{\lambda}_2 \end{bmatrix}$ by solving the exterior problem.
 \item Calculate the solvation energy.
\end{enumerate}
